# Phase Backcast (1-100)

このドキュメントは、`patchgate` を **Phase100 の到達状態** から逆算し、`Phase1` から順に実装する設計です。

## Phase100 の到達状態

- PR差分品質ゲートとして、複数言語・大規模リポジトリで安定運用できる
- ローカル/CI主導の低コスト実行を維持しつつ、履歴可視化と運用分析が可能
- ルール配布・監査・権限分離を備えたチーム運用が可能
- API/CLI/GitHub連携が整合し、拡張機構で独自チェックを追加できる
- LTS運用可能な品質（テスト、性能、ドキュメント、移行ガイド）を満たす

## 逆算した「最初に実装すること」

Phase1-20 で先に固める対象:

1. 差分収集と3チェックの判定精度を安定化
2. `policy.toml` の互換性ルールとバリデーションの明確化
3. JSON/Markdown出力の契約固定（下位互換を意識）
4. キャッシュ・ベンチ・テストでCIの再現性を確保
5. GitHub publish と障害時フォールバックを実運用レベルに引き上げる

## 詳細設計ドキュメント

- [PR Plan: Phase1-10](07_pr_plan_phase1_10.md)
- [PR Plan: Phase11-20](08_pr_plan_phase11_20.md)
- [PR Plan: Phase21-30](../phase21_30.md)
- [PR Plan: Phase31-40](../phase31_40.md)

## Phase 1-10 (MVP基盤固定)

1. リポジトリ内規の固定 (`just`, lint, test, fmt の共通化)
2. `scan` 実行パスのエラーハンドリング統一
3. `ScopeMode` ごとの差分収集境界テスト追加
4. `test_gap` の誤検知低減 (除外/テスト判定見直し)
5. `dangerous_change` のcritical判定テーブル整理
6. `dependency_update` のmanifest/lock判定精度向上
7. スコア計算ロジックの境界値テスト固定
8. JSONスキーマ(事実上契約)の明文化
9. Markdownコメントの見出し・優先度表示改善
10. SQLiteキャッシュキーと無効化条件を固定

## Phase 11-20 (安定運用の最小単位)

11. `policy.toml` のバリデーションエラー分類
12. デフォルト設定とexample設定の差分ゼロ化
13. `doctor` の診断項目拡張 (git/config/cache)
14. GitHub publish 失敗時の部分成功処理を追加
15. PR番号/sha解決の環境依存テスト追加
16. 出力フォーマットの後方互換ルールを定義
17. キャッシュDBの破損時復旧フローを実装
18. ベンチマーク基準値の導入 (実行時間/ファイル数)
19. 主要経路の結合テスト (CLI -> core -> github) を整備
20. リリース前チェックの自動化範囲を拡大

## Phase 21-30 (Policy管理と互換性)

21. Policy version フィールド導入
22. Policy migration CLI (`policy migrate`) の雛形
23. 互換性マトリクス文書化
24. ルールプリセット (strict/balanced/relaxed) 導入
25. リポジトリ別overrideの評価順序固定
26. しきい値のチェック別重み再設計
27. ルール説明文の機械可読化
28. ポリシーlintコマンド追加
29. 破壊的設定変更の検出
30. policy配布手順(タグ/ピン留め)を標準化

### 設計要点 (Phase21-30)

- 方針: 「互換性を守りながら、段階移行できるPolicy管理」を優先
- 変更タイプ: 設定スキーマ、CLIサブコマンド、ドキュメント契約
- 非機能要件:
  - 同一Policyで再実行したときに同じ判定になる（決定性）
  - migration/lintがCIで実行可能（自動検証）
  - 破壊的変更は `policy migrate` で明示的に適用
- 完了判定:
  - policy version付き設定の読込・検証・移行がテストで固定
  - preset/override適用順が仕様化され、実装とdocsが一致
  - 互換性ポリシー（追加/非推奨/破壊）に沿った変更手順が確立

## Phase 31-40 (GitHub連携の本番化)

31. Check Run の結論マッピング精緻化
32. PRコメントのidempotent更新強化
33. publish retry/backoff実装
34. API rate limit時の劣化運転
35. GitHub App/token両対応の抽象化
36. 自動ラベル付与連携(任意)
37. PRテンプレ連携のメッセージ改善
38. コメント抑制ルール(ノイズ削減)
39. publish dry-runモード導入
40. GitHub連携のE2Eテスト整備

### 設計要点 (Phase31-40)

- 方針: 「失敗しにくく、再実行に強いGitHub連携」を優先
- 変更タイプ: APIクライアント挙動、publish制御、CI統合テスト
- 非機能要件:
  - idempotent更新（同PR再実行で重複コメントを作らない）
  - 部分成功を許容しつつ失敗理由を分離して可視化
  - rate limit/一時障害時の劣化運転と再試行を標準化
- 完了判定:
  - check run結論とgate判定の対応が契約化される
  - publish retry/backoffとdry-runがCLIオプションで制御可能
  - GitHub実環境に近いE2Eテストで主要シナリオを再現可能

## Phase 41-50 (性能とスケール)

41. diff収集のプロセス起動回数最適化
42. 大規模差分のメモリ使用量削減
43. チェック並列化の設計導入
44. キャッシュI/Oバッチ化
45. 変更ファイル数上限時の挙動定義
46. プロファイル計測コマンド追加
47. 10kファイル想定の負荷試験
48. Windows環境での性能劣化分析
49. P95実行時間SLOの定義
50. 性能回帰をCIで検知

## Phase 51-60 (言語別検知の強化)

51. Rust向けテスト検知精度改善
52. TypeScript向けテスト検知精度改善
53. Python向けテスト検知精度改善
54. Go向けテスト検知精度改善
55. Java/Kotlin向け検知追加
56. 依存更新リスクのエコシステム別拡張
57. lockfile差分の重大度モデル拡張
58. 生成コードの扱い方針を追加
59. モノレポ向けパッケージ境界判定
60. 言語別ルールの有効化戦略を整理

## Phase 61-70 (運用監視と可観測性)

61. 実行メトリクス出力(JSONL)追加
62. 失敗分類コード(原因種別)追加
63. 監査ログの最小要件定義
64. 実行履歴の集計CLI追加
65. リポジトリ別トレンド可視化の土台
66. アラート閾値(急激悪化)定義
67. 週次サマリ生成の自動化
68. 運用runbook整備
69. 障害復旧手順の演習
70. MTTR短縮のための診断出力改善

## Phase 71-80 (セキュリティ/ガバナンス)

71. トークン取り扱い最小権限化
72. 秘匿情報マスキング強化
73. 監査証跡フォーマット固定
74. SSO/組織制約への対応方針
75. ルール変更の承認フロー導入
76. 例外承認(waiver)期限管理
77. 監査レポート自動生成
78. コンプライアンスチェックリスト整備
79. サプライチェーン観点の補助検知
80. セキュリティレビューの定例化

## Phase 81-90 (拡張性とエコシステム)

81. 外部チェックプラグインAPI設計
82. プラグイン実行sandbox方針
83. 公式プラグインSDK雛形
84. ルールマーケット(配布形式)設計
85. CI provider拡張(非GitHub)抽象化
86. Webhook連携基盤
87. カスタム通知先連携
88. ドキュメントサイト整備
89. サンプルリポジトリ群作成
90. コミュニティ運用ガイド公開

## Phase 91-100 (製品化・LTS)

91. v1.0 RCの仕様凍結
92. 移行ガイド(v0.x -> v1.0)作成
93. 破壊的変更の最終調整
94. LTSサポート方針策定
95. SLA/SLO定義公開
96. 商用運用向け導入ガイド整備
97. 大規模導入PoC完了
98. v1.0 GA判定レビュー
99. GAリリース実行
100. ポストGA改善計画(Phase101+)確定

## 補足

- 各Phaseは「実装 + テスト + ドキュメント + CI更新」までを完了条件とする
- Phase1-20 は原則として後方互換優先（CLI引数・JSON項目の破壊変更を避ける）
- Phase21-40 は「互換性維持を前提に、運用性と障害耐性を先に高める」
- PRの粒度は「レビュー1回で判断できる変更量」を上限にする
