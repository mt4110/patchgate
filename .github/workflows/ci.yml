name: CI

on:
  push:
  pull_request:

jobs:
  nix-linux:
    name: nix (ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v30
      - name: fmt/lint/test (shared just recipe)
        run: nix develop --command just ci-check

      - name: Lint policy compatibility matrix
        run: |
          nix develop --command cargo run -p patchgate-cli -- policy lint \
            --path config/policy.toml.example \
            --require-current-version
          for preset in strict balanced relaxed; do
            nix develop --command cargo run -p patchgate-cli -- policy lint \
              --path "config/presets/${preset}.toml" \
              --require-current-version
          done

      - name: GitHub publish dry-run E2E path
        run: |
          nix develop --command cargo run -p patchgate-cli -- scan \
            --scope staged \
            --mode warn \
            --format json \
            --github-publish \
            --github-dry-run \
            --github-repo example/repo \
            --github-pr 1 \
            --github-sha deadbeef \
            --github-dry-run-output artifacts/github-payload.json

  cross-platform:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: test
        run: cargo test --workspace
