name: Release Precheck

on:
  pull_request:
  workflow_dispatch:

jobs:
  precheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v30

      - name: Ensure macOS metadata files are not tracked
        run: |
          if git ls-files '._*' '**/._*' | grep .; then
            echo "Found forbidden macOS metadata files in git index."
            exit 1
          fi

      - name: Run fmt/lint/test
        run: nix develop --command just ci-check

      - name: Run patchgate doctor
        run: nix develop --command cargo run -p patchgate-cli -- doctor

      - name: Policy lint (example + presets)
        run: |
          nix develop --command cargo run -p patchgate-cli -- policy lint \
            --path config/policy.toml.example \
            --require-current-version
          for preset in strict balanced relaxed; do
            nix develop --command cargo run -p patchgate-cli -- policy lint \
              --path "config/presets/${preset}.toml" \
              --require-current-version
          done

      - name: GitHub publish dry-run smoke test
        run: |
          nix develop --command cargo run -p patchgate-cli -- scan \
            --scope staged \
            --mode warn \
            --format json \
            --github-publish \
            --github-dry-run \
            --github-repo example/repo \
            --github-pr 1 \
            --github-sha deadbeef \
            --github-dry-run-output artifacts/github-payload.json

      - name: Benchmark baseline compare
        run: |
          nix develop --command cargo run -p xtask -- bench compare \
            --case ci-worktree \
            --output config/benchmarks/ci-worktree-baseline.jsonl \
            --require-baseline \
            --report-output artifacts/bench-compare.json

      - name: Capture scan profile
        run: |
          nix develop --command cargo run -p xtask -- bench profile \
            --repo . \
            --profile-output artifacts/scan-profile.json

      - name: Upload performance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-precheck-performance
          path: artifacts/
